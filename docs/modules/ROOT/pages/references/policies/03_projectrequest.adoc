//
// This page is autogenerated from `tools/render/templates/policy.adoc -- DO NOT EDIT manually
//
= Policy: `organization-in-projectrequests`

[abstract]
Check the requesting user's default organization for OpenShift ProjectRequests.

[horizontal]
Category:: Namespace Ownership
Minimum Kyverno version:: v1
Subject:: APPUiO Organizations
Policy type:: "generate"
Implementation:: https://github.com/appuio/component-appuio-cloud/tree/master/component/project-policies.jsonnet[component/project-policies.jsonnet]

This policy will check that the requesting user has the `appuio.io/default-organization` annotation.
The content of the annotation isn't validated.
Instead the policy assumes that any default organization annotations which are present on user objects are valid.

If the requesting user doesn't have the `appuio.io/default-organization` annotation, the project request is denied.

Users which match an entry of xref:references/parameters#_bypassnamespacerestrictions[component parameter `bypassNamespaceRestrictions`] are allowed to bypass the policy.


== Policy Definition

.https://github.com/appuio/component-appuio-cloud/tree/master//tests/golden/defaults/appuio-cloud/appuio-cloud/03_projectrequest.yaml[/tests/golden/defaults/appuio-cloud/appuio-cloud/03_projectrequest.yaml,window=_blank]
[source,yaml]
----
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  annotations:
    policies.kyverno.io/category: Namespace Ownership
    policies.kyverno.io/description: 'This policy will check that the requesting user
      has the `appuio.io/default-organization` annotation.

      The content of the annotation isn''t validated.

      Instead the policy assumes that any default organization annotations which are
      present on user objects are valid.


      If the requesting user doesn''t have the `appuio.io/default-organization` annotation,
      the project request is denied.


      Users which match an entry of xref:references/parameters#_bypassnamespacerestrictions[component
      parameter `bypassNamespaceRestrictions`] are allowed to bypass the policy.

      '
    policies.kyverno.io/jsonnet: component/project-policies.jsonnet
    policies.kyverno.io/minversion: v1
    policies.kyverno.io/subject: APPUiO Organizations
    policies.kyverno.io/title: Check the requesting user's default organization for
      OpenShift ProjectRequests.
  labels:
    app.kubernetes.io/component: appuio-cloud
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud
    name: organization-in-projectrequests
  name: organization-in-projectrequests
spec:
  background: false
  rules:
    - context:
        - apiCall:
            jmesPath: '@'
            urlPath: /apis/user.openshift.io/v1/users/{{request.userInfo.username}}
          name: ocpuser
      exclude:
        clusterRoles:
          - cluster-admin
          - cluster-image-registry-operator
          - cluster-node-tuning-operator
          - kyverno:generatecontroller
          - kyverno:policycontroller
          - multus-admission-controller-webhook
          - openshift-dns-operator
          - openshift-ingress-operator
          - syn-admin
          - syn-argocd-application-controller
          - syn-argocd-server
          - syn-resource-locker-namespace-default-manager
          - syn-resource-locker-namespace-openshift-monitoring-manager
          - system:controller:generic-garbage-collector
          - system:controller:operator-lifecycle-manager
          - system:master
          - system:openshift:controller:namespace-security-allocation-controller
        roles: []
        subjects:
          - kind: ServiceAccount
            name: argocd-application-controller
            namespace: argocd
      match:
        all:
          - resources:
              kinds:
                - ProjectRequest
      name: user-has-default-organization
      validate:
        deny:
          conditions:
            - key: '{{ocpuser.metadata.annotations."appuio.io/default-organization"}}'
              operator: Equals
              value: ''
        message: You cannot create Projects without belonging to an organization
  validationFailureAction: enforce

----
