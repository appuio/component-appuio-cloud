apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  annotations: {}
  labels:
    app.kubernetes.io/component: appuio-cloud
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud
    name: organization-namespaces
  name: organization-namespaces
spec:
  background: false
  rules:
    - context:
        - apiCall:
            jmesPath: '@'
            urlPath: /apis/user.openshift.io/v1/users/{{request.userInfo.username}}
          name: ocpuser
      exclude:
        clusterRoles:
          - cluster-admin
          - cluster-image-registry-operator
          - cluster-node-tuning-operator
          - kyverno:generatecontroller
          - kyverno:policycontroller
          - multus-admission-controller-webhook
          - openshift-dns-operator
          - openshift-ingress-operator
          - syn-admin
          - syn-argocd-application-controller
          - syn-argocd-server
          - syn-resource-locker-*
          - system:controller:generic-garbage-collector
          - system:controller:operator-lifecycle-manager
          - system:master
          - system:openshift:controller:namespace-security-allocation-controller
        roles: []
        subjects:
          - kind: ServiceAccount
            name: argocd-application-controller
            namespace: argocd
      match:
        all:
          resources:
            kinds:
              - Namespace
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              +(appuio.io/organization): '{{ocpuser.metadata.annotations."appuio.io/default-organization"}}'
      name: set-default-organization-ns
    - context:
        - apiCall:
            jmesPath: '@'
            urlPath: /apis/user.openshift.io/v1/users/{{request.object.metadata.annotations."openshift.io/requester"}}
          name: ocpuser
      exclude: {}
      match:
        all:
          - resources:
              annotations:
                openshift.io/requester: ?*
              kinds:
                - Project
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              +(appuio.io/organization): '{{ocpuser.metadata.annotations."appuio.io/default-organization"}}'
      name: set-default-organization-project
    - exclude:
        clusterRoles:
          - cluster-admin
          - cluster-image-registry-operator
          - cluster-node-tuning-operator
          - kyverno:generatecontroller
          - kyverno:policycontroller
          - multus-admission-controller-webhook
          - openshift-dns-operator
          - openshift-ingress-operator
          - syn-admin
          - syn-argocd-application-controller
          - syn-argocd-server
          - syn-resource-locker-*
          - system:controller:generic-garbage-collector
          - system:controller:operator-lifecycle-manager
          - system:master
          - system:openshift:controller:namespace-security-allocation-controller
        roles: []
        subjects:
          - kind: ServiceAccount
            name: argocd-application-controller
            namespace: argocd
      match:
        resources:
          kinds:
            - Namespace
      name: has-organization
      validate:
        message: Namespace must have organization
        pattern:
          metadata:
            labels:
              appuio.io/organization: ?*
    - context:
        - apiCall:
            jmesPath: items
            urlPath: /apis/user.openshift.io/v1/groups
          name: groups
      exclude:
        clusterRoles:
          - cluster-admin
          - cluster-image-registry-operator
          - cluster-node-tuning-operator
          - kyverno:generatecontroller
          - kyverno:policycontroller
          - multus-admission-controller-webhook
          - openshift-dns-operator
          - openshift-ingress-operator
          - syn-admin
          - syn-argocd-application-controller
          - syn-argocd-server
          - syn-resource-locker-*
          - system:controller:generic-garbage-collector
          - system:controller:operator-lifecycle-manager
          - system:master
          - system:openshift:controller:namespace-security-allocation-controller
        roles: []
        subjects:
          - kind: ServiceAccount
            name: argocd-application-controller
            namespace: argocd
      match:
        resources:
          kinds:
            - Namespace
      name: is-in-organization
      preconditions:
        - key: '{{request.object.metadata.labels."appuio.io/organization"}}'
          operator: NotEquals
          value: ''
      validate:
        deny:
          conditions:
            - key: '{{request.userInfo.username}}'
              operator: NotIn
              value: '{{groups[?metadata.name==''{{request.object.metadata.labels."appuio.io/organization"}}''].users[]}}'
        message: Creating namespace for {{request.object.metadata.labels."appuio.io/organization"}}
          but {{request.userInfo.username}} is not in organization
  validationFailureAction: enforce
