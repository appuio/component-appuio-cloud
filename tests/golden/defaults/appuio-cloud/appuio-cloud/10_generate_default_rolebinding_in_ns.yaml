apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  annotations:
    pod-policies.kyverno.io/autogen-controllers: none
  labels:
    app.kubernetes.io/component: appuio-cloud
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud
    name: default-rolebinding-in-ns
  name: default-rolebinding-in-ns
spec:
  rules:
    - generate:
        data:
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: admin
          subjects:
            - kind: Group
              name: '{{request.object.metadata.labels."appuio.io/organization"}}'
        kind: RoleBinding
        name: admin
        namespace: '{{request.object.metadata.name}}'
        synchronize: false
      match:
        all:
          - resources:
              kinds:
                - Namespace
              selector:
                matchExpressions:
                  - key: appuio.io/organization
                    operator: Exists
      name: default-rolebinding
    - context:
        - apiCall:
            jmesPath: metadata.labels."appuio.io/organization"
            urlPath: /api/v1/namespaces/{{request.object.metadata.namespace}}
          name: organization
      match:
        all:
          - resources:
              kinds:
                - rbac.authorization.k8s.io/v1/RoleBinding
              names:
                - admin
              selector:
                matchLabels:
                  appuio.io/uninitialized: 'true'
      mutate:
        patchesJson6902: "- \"name\": \"update-rolebinding\"\n  \"op\": \"add\"\n\
          \  \"path\": \"/subjects\"\n  \"value\":\n  - \"apiGroup\": \"rbac.authorization.k8s.io\"\
          \n    \"kind\": \"Group\"\n    \"name\": \"{{organization}}\"\n- \"op\"\
          : \"remove\"\n  \"path\": \"/metadata/labels/appuio.io~1uninitialized\""
      name: patch-uninitialized-default-rolebinding
    - generate:
        data:
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: namespace-owner
          subjects:
            - kind: Group
              name: '{{request.object.metadata.labels."appuio.io/organization"}}'
        kind: RoleBinding
        name: namespace-owner
        namespace: '{{request.object.metadata.name}}'
        synchronize: false
      match:
        all:
          - resources:
              kinds:
                - Namespace
              selector:
                matchExpressions:
                  - key: appuio.io/organization
                    operator: Exists
      name: namespace-edit-rolebinding
