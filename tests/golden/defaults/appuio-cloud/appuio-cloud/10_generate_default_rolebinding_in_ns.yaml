apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  annotations: {}
  labels:
    app.kubernetes.io/component: appuio-cloud
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud
    name: default-rolebinding-in-ns
  name: default-rolebinding-in-ns
spec:
  rules:
    - generate:
        data:
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: admin
          subjects:
            - kind: Group
              name: '{{request.object.metadata.labels."appuio.io/organization"}}'
        kind: RoleBinding
        name: admin
        namespace: '{{request.object.metadata.name}}'
        synchronize: false
      match:
        all:
          - resources:
              kinds:
                - Namespace
              selector:
                matchExpressions:
                  - key: appuio.io/organization
                    operator: Exists
      name: default-rolebinding
    - context:
        - apiCall:
            jmesPath: metadata.labels."appuio.io/organization"
            urlPath: /api/v1/namespaces/{{request.object.metadata.namespace}}
          name: organization
      match:
        all:
          - resources:
              kinds:
                - rbac.authorization.k8s.io/v1/RoleBinding
              names:
                - admin
              selector:
                matchLabels:
                  appuio.io/uninitialized: 'true'
      mutate:
        patchesJson6902: "- op: add\n  path: \"/subjects\"\n  value: [{\"apiGroup\"\
          :\"rbac.authorization.k8s.io\",\"kind\":\"Group\",\"name\":\"{{organization}}\"\
          }]\n  name: update-rolebinding\n- op: remove\n  path: \"/metadata/labels/appuio.io~1uninitialized\"\
          \n"
      name: patch-uninitialized-default-rolebinding
    - generate:
        data:
          rules:
            - apiGroups:
                - ''
              resources:
                - namespaces
              verbs:
                - get
                - watch
                - edit
                - patch
                - delete
        kind: Role
        name: namespace-owner
        namespace: '{{request.object.metadata.name}}'
        synchronize: false
      match:
        all:
          - resources:
              kinds:
                - Namespace
              selector:
                matchExpressions:
                  - key: appuio.io/organization
                    operator: Exists
      name: namespace-edit-role
    - generate:
        data:
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: Role
            name: namespace-owner
          subjects:
            - kind: Group
              name: '{{request.object.metadata.labels."appuio.io/organization"}}'
        kind: RoleBinding
        name: namespace-owner
        namespace: '{{request.object.metadata.name}}'
        synchronize: false
      match:
        all:
          - resources:
              kinds:
                - Namespace
              selector:
                matchExpressions:
                  - key: appuio.io/organization
                    operator: Exists
      name: namespace-edit-rolebinding
