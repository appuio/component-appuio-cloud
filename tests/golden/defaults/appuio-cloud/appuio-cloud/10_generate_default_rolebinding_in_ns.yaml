apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  annotations: {}
  labels:
    app.kubernetes.io/component: appuio-cloud
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud
    name: default-rolebinding-in-ns
  name: default-rolebinding-in-ns
spec:
  rules:
    - generate:
        data:
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: admin
          subjects:
            - kind: Group
              name: '{{request.object.metadata.labels."appuio.io/organization"}}'
        kind: RoleBinding
        name: organization-admin
        namespace: '{{request.object.metadata.name}}'
        synchronize: false
      match:
        any:
          - resources:
              kinds:
                - Namespace
              selector:
                matchExpressions:
                  - key: appuio.io/organization
                    operator: Exists
      name: default-rolebinding
    - generate:
        data:
          rules:
            - apiGroups:
                - ''
              resources:
                - namespaces
              verbs:
                - get
                - watch
                - edit
                - patch
        kind: Role
        name: namespace-owner
        namespace: '{{request.object.metadata.name}}'
        synchronize: false
      match:
        any:
          - resources:
              kinds:
                - Namespace
              selector:
                matchExpressions:
                  - key: appuio.io/organization
                    operator: Exists
      name: namespace-edit-role
    - generate:
        data:
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: Role
            name: namespace-owner
          subjects:
            - kind: Group
              name: '{{request.object.metadata.labels."appuio.io/organization"}}'
        kind: RoleBinding
        name: namespace-owner
        namespace: '{{request.object.metadata.name}}'
        synchronize: false
      match:
        any:
          - resources:
              kinds:
                - Namespace
              selector:
                matchExpressions:
                  - key: appuio.io/organization
                    operator: Exists
      name: namespace-edit-rolebinding
